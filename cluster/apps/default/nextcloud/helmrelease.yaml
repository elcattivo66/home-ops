apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: &app nextcloud
  namespace: default
spec:
  interval: 15m
  chart:
    spec:
      chart: nextcloud
      version: 3.2.3
      sourceRef:
        kind: HelmRepository
        name: nextcloud-charts
        namespace: flux-system
      interval: 15m
  install:
    createNamespace: true
    remediation:
      retries: 5
  upgrade:
    remediation:
      retries: 5
  values:
    fullnameOverride: *app
    image:
      repository: nextcloud
      tag: 25.0.0-apache
      # flavor: fpm-alpine
    ingress:
      enabled: false
    nextcloud:
      configs:
        # custom.config.php: |-
        #   <?php
        #   $CONFIG = array (
        #     'overwriteprotocol' => 'https',
        #     'overwrite.cli.url' => 'https://nextcloud.elcattivo.de',
        #     'overewritehost' => 'nextcloud.elcattivo.de',
        #     'filelocking.enabled' => 'true',
        #     'loglevel' => '2',
        #     'enable_previews' => true,
        #     'trusted_domains' =>
        #       [
        #         'nextcloud',
        #         'nextcloud.elcattivo.de',
        #         'localhost',
        #         '10.42.3.*',
        #         '192.168.178.*',
        #       ],
        #     'trusted_proxies' =>
        #     array (
        #       0 => '10.42.3.0/16',
        #     ),
        #   );
        s3.config.php: |-
          <?php
          $CONFIG = array (
            'objectstore' => array(
              'class' => '\\OC\\Files\\ObjectStore\\S3',
              'arguments' => array(
                'bucket'     => 'nextcloud-data',
                'autocreate' => true,
                'key'        => '${MINIO_SECRET_KEY}',
                'secret'     => '${MINIO_ACCESS_KEY}',
                'region'     => 'eu-central-1',
                'hostname'   => '192.168.178.83:9102',
                'use_ssl'    => false,
                'use_path_style' => true
              )
            )
          );

      host: nextcloud.${SECRET_DOMAIN}
      existingSecret:
        enabled: true
        secretName: nextcloud-secret
      # datadir: /var/www/data
      extraEnv:
        - name: REDIS_HOST
          value: redis-master.databases.svc.cluster.local
        - name: REDIS_HOST_PORT
          value: "6379"
        - name: REDIS_HOST_PASSWORD
          valueFrom:
            secretKeyRef:
              name: nextcloud-secret
              key: redis-password
    # nginx:
    #   enabled: true
    #   image:
    #     repository: nginx
    #     tag: 1.23-alpine
    internalDatabase:
      enabled: false      
    externalDatabase:
      enabled: true
      type: postgresql
      host: postgres-rw.databases.svc.cluster.local:5432
      database: nextcloud
      existingSecret:
        enabled: true
        secretName: nextcloud-pg-secret
        usernameKey: user
        passwordKey: password

    persistence:
      enabled: true
      existingClaim: nextcloud-config-v1
      # nextcloudData:
      #   enabled: true
      #   existingClaim: nextcloud-data

    cronjob:
      annotations: {}
      curlInsecure: false
      enabled: false
      failedJobsHistoryLimit: 3
      image: {}
      schedule: '*/5 * * * *'
      successfulJobsHistoryLimit: 2

    hpa:
      enabled: false
    startupProbe:
      enabled: false
    resources:
      requests:
        cpu: 100m
        memory: 150Mi
